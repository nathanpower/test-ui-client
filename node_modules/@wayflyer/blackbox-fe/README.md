# blackbox-fe

![blackbox-fe](https://user-images.githubusercontent.com/110820894/193263877-9cf5bc69-b837-4e6a-93f5-7d9be85346fc.png)

## Overview

blackbox-fe offers

> - An initialization flow for Datadog
> - An error boundary to wrap your application in which is hooked up with Datadog out of the box
> - A `useErrorHandler` hook which can be used to catch exceptions which fall out of the reach of the error boundary (see limitations).
> - Utilities to help build out addiitonal context for errors / logs `[addAction, addError, setUser, setUserProperty, clearUser, removeUserProperty]`

<br />

---

<br />

## Usage

The ideal use case for this component is to have it placed _once_, somewhere near the top level of your application tree so to be able to catch [thrown](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/throw) [errors](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error) from its child components.

<br />

## Example

```TS

import { BlackBox, initialise } from "@wayflyer/blackbox-fe";
import { Financing } from './Financing';

const CustomFallbackComponent = ({ error, resetErrorBoundary }) => {
  return (
        <>
            <h3>Uh Ohhhh!</h3>
            <button onClick={resetErrorBoundary}>Try again</button>
        </>
    );
};

const dataDogConfig = {
    applicationId: "c2f5ed75-ca0f-4194-4444-w132132sse",
    clientToken: "pubd4045714a73d50e4cc7bb23232111",
    site: "datadoghq.eu",
    service: "wayflyer-xtreme",
    trackInteractions: true,
    sampleRate: 90,
    version: "12.2.3",
    env: "prod",
    user: {
        id: "13123124aweaea-eawea2323d",
        name: "Bob"
    }
};

initialise({
  datadog: dataDogConfig,
});

export const WayflyerApp = (props) => {

  const handleApplicationErrors = (error, info) => {
    sendErrorElsewhere(error, info)
  };

  return (
  <AxiosProvider>
    <RootContainer>
      <BlackBox
        FallbackComponent={CustomFallbackComponent}
      >
        <Financing {...props} />
      </BlackBox>
     </RootContainer>
    </AxiosProvider>
  );
}
```

<br /><br />

## Props

<br />

| Name              | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Description                                                                                                                                                                                                                                                                                                                                                                | Required |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| children          | ReactChildren                                                                                                                                                                                                                                                                                                                                                                                                                                                               | The components which the <br>error boundary will wrap                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | A callback function can be used to try to re-initialise our application state into a "working"<br>state before attempting to re-render the children. If no handler is provided it will default to try reload the page                                                                                                                                                      | no       |
| FallbackComponent | React.ReactElement<unknown,string \| React.FunctionComponent \| typeof React.Component \| null`                                                                                                                                                                                                                                                                                                                                                                             | The render method called when an exception is thrown within the ErrorBoundary. It receives the Error instance that triggered it, as well as the resetErrorBoundary function which will reset the error boundaries internal state. You can use this to render a custom fallback error component, leveraging the error / resetErrroBoundary to handle unexpected exceptions. | yes      |

<br />

---

<br />

## Data Dog initialization

The initialisation function should be called once, before React mounts.

```
initialise({
  datadog: dataDogConfig,
});
```

<br />

---

<br />

## Error Boundary

An Error boundary ensures that your errors stay scoped in it, not breaking the full React tree in case of error. For every error caught, an [`Error`](https://docs.datadoghq.com/real_user_monitoring/#error-tracking-and-crash-reporting) event will be sent to your Datadog dashboards and RUM Explorer.

<br />

### Limitations of Error Boundaries in react

Error boundaries do not catch errors for:

> - Event handlers (learn more)
> - Asynchronous code (e.g. setTimeout or requestAnimationFrame callbacks)
> - Server side rendering
> - Errors thrown in the error boundary itself (rather than its children)

To overcome these limitations, we've exposed the `useErrorBoundary` hook which can help to bridge the gap for the above cases by allowing you to essentially catch an error and bubble it up to the error boundary to deal with just as normal.

If you are making a request using `react-query` it's easier to use the `throwOnError` option to instruct the library to rethrow a synchronous rendering error.

<br />

### useErrorBoundary Example

```TSX
function Example() {
  const { showBoundary } = useErrorBoundary();

  return (
    <Button
      variant="Secondary"
      onClick={async () => {
        try {
          await axios.post(URL);
        } catch (error) {
          showBoundary(error);
        }
      }}
    >
      Make Request
    </Button>
  );
}
```

---

<br />

## Utilities

---

<br />

### `addAction`

<br />

Create a RUM (Realtime User Monitoring) action using the addAction API. Give your action a name and attach context attributes in the form of a JavaScript object. This can also be leveraged a means to log the occurance of an event that doesn't fall within the bounds of an error, but you want to track its occurance nonetheless.

Actions can be viewed and searched for via the Sessions & Replays section of Datadog RUM UI. (Navbar -> UX Monitoring > RUM Applications > [Your application] > Sessions & Replays (tab))

```
import { addAction } from '@wayflyer/blackbox-fe';

function onCheckoutButtonClick(cart) {
    addAction('checkout', {
        'value': cart.value, // for example, 42.12
        'items': cart.items, // for example, ['tomato', 'strawberries']
    })
}
```

### `addError`

<br />

Collecting errors manually.

```
import { addError } from '@wayflyer/blackbox-fe';

function AAAAAAAAAAAAAAAAAAAAAAAH(goesBANG) {

  addError(error, {
      pageStatus: 'beta',
  });

  // Send a network error
  fetch('<SOME_URL>').catch(function(error) {
    addError(error);
  })

  // Send a handled exception error
  try {
      //Some code logic
  } catch (error) {
      addError(error);
  }

}
```

### `logger`

<br />

A logger class that exposes methods/functions for the various logging levels. You can pass a message which identifies the log and additional message context as an object (see below)

> logger.debug | info | warn | error (message: string, messageContext?: Context, error?: Error)

```TS
import { logger } from '@wayflyer/blackbox-fe';

function doTheThing(theThing) {
  // Send a log via browser-logs to datadog
  fetch('<SOME_URL>').catch(function(error) {
    logger.info('Done the Thing!', { name: 'Roger', id: 123 })
  })

  // Send a handled exception error
  try {
      //Some code logic
  } catch (error) {
      logger.error('Blew up when trying to do the thing', { error })
  }

}
```

### `setUser`

<br />

The following attributes are optional but Datadog recommends providing at least one of them:

- usr.id String Unique user identifier.
- usr.name String User friendly name, displayed by default in the RUM UI.
- usr.email String User email, displayed in the RUM UI if the user name is not present. It is also used to fetch Gravatars.

<br />
Increase your filtering capabilities by adding extra attributes on top of the recommended ones. For instance, add information about the user plan, or which user group they belong to.

<br />

> _Note:_ When making changes to the user session object, all RUM events collected after the change contain the updated information.

> _Note:_ You can initialise datadog with a user profile directly via the datadogInitConfig prop, however, in some circumstances you may want to take control when that user is initialised.

<br />

```TS
import { setUser } from '@wayflyer/blackbox-fe';

const onLoginSuccess = () => {

  setUser({
      id: '1234',
      name: 'John Doe',
      email: 'john@doe.com',
      plan: 'premium',
      ...
  });
}
```

<br />

### `setUserProperty`

<br />

Add/Override user session property

```TS
import { setUserProperty } from '@wayflyer/blackbox-fe';

const updateUserName = ({ uname: 'The Batman' }) => {

  setUserProperty('name', uname)
}

```

### `clearUser`

<br />

Clear user session property

```TS
import { clearUser } from '@wayflyer/blackbox-fe';

const handleSignout = () => {

 clearUser();
 clearUserCookies();
 navigate('/login/');
}

```

### `removeUserProperty`

<br />

Remove user session property

```TS
import { removeUserProperty } from '@wayflyer/blackbox-fe';

removeUserProperty('name');

```

---

<br />

## Expected results

Your errors will appear in Datadog's Dashboards and RUM Explorer, as they would appear by using [`addError`](https://docs.datadoghq.com/real_user_monitoring/browser/collecting_browser_errors/?tab=npm#collect-errors-manually). The wrapped UI in your application is expected to not crash, display any console errors, or not show any ominous error messages.
